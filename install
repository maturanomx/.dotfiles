#!/usr/bin/env bash

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source ${SCRIPT_DIR}/environment

link() {
	if [[ ! -L "${2}" || "$(readlink "${2}")" != "${1}" ]]; then
		rm -rf "${2}"
		ln -sv "${1}" "${2}"
	fi
}

OS="$(uname)"
if [[ "${OS}" == "Linux" ]]; then
	sudo apt update
	sudo apt -y upgrade
	sudo apt -y install build-essential curl file git libreadline-dev procps
fi

SSH_TYPE="ed25519"
SSH_FILENAME="${HOME}/.ssh/id_${SSH_TYPE}"
if [[ ! -f "${SSH_FILENAME}" ]]; then
	ssh-keygen -t "${SSH_TYPE}" -N "" -f "${SSH_FILENAME}" -C "$(hostname)"
fi

if [[ ! -z "$(command -v brew)" ]]; then
	NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(brew shellenv)"
brew bundle --file="${DOTFILES}/Brewfile"

mkdir -p ${HOME}/.{config,private}

# GIT
if [[ ! -f "${HOME}/.private/gitconfig" ]]; then
	read -p "Enter you name: " NAME
	read -p "Enter your email: " EMAIL
	cat <<_git_user >${HOME}/.private/gitconfig
[user]
	email = ${EMAIL}
	name = ${NAME}
_git_user
fi
link ${DOTFILES}/git/gitconfig ${HOME}/.gitconfig

# ZSH
link ${DOTFILES}/environment ${HOME}/.zshenv
link ${DOTFILES}/zsh/zshrc ${HOME}/.zshrc

link ${DOTFILES}/bat ${HOME}/.config/bat
link ${DOTFILES}/nvim ${HOME}/.config/nvim
link ${DOTFILES}/wezterm/wezterm.lua ${HOME}/.wezterm.lua

if [[ ! -f "${HOME}/.private/bugwarrior.toml" ]]; then
	cp ${DOTFILES}/task/bugwarrior.toml ${HOME}/.private/
fi

bat cache --build
